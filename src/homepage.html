<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<style> 


    div.tooltip {	
        position: absolute;			
        text-align: left;			
        width: 140px;					
        height: 111px;					
        padding-left: 5px;
        padding-top: 2px;
        padding-bottom: 3px;
        padding-right: 2px;
        font: 12px sans-serif;		
        background: lightsteelblue;	
        border: 0px;		
        border-radius: 8px;			
        pointer-events: none;			
    }

    .gridline {
        stroke: lightgrey;
        stroke-opacity: 0.2;
        shape-rendering: crispEdges;
    }

    .plotdiv {
        margin-left: 140px;
    }

    .ylabel {
        font-size: 12px;
    }

    .xlabel {
        font-size: 12px;
    }

    .annotation-group-scene-1 {
        opacity: 1;
    }

    .annotation-group-scene-2 {
        opacity: 0;
    }

    .annotation-group-scene-3 {
        opacity: 0;
    }

    .labels1 {
        pointer-events: none;
    }

    .labels2 {
        pointer-events: none;
    }

    
    </style>
    <body onload='init()'>

        <select id="yearButton1"></select>
        <select id="yearButton2"></select>
        <select id="champButton"></select>

        <div class="plotdiv" id="plot">
        </div>

        <script>

            async function init() {
                 
                var margin = {x: 50, y: 50},
                width = 900, height = 550;

                // P+B or P% or B%
                var xScale = d3.scaleLinear().domain([0,1]).range([0, 800]);
                
                // W%
                var yScale = d3.scaleLinear().domain([0,1]).range([450, 0]);

                var sizeScale = d3.scaleLinear().domain([0,57]).range([75, 500]);
                
                var data = await d3.csv("/worlds.csv")
                var allYears = d3.map(data, function(d){return(d.Year)}).keys()      
                var allChamps = d3.map(data, function(d){return(d.Champion)}).keys()

                // Define SVG
                var svg = d3.select("#plot")
                .append("svg")
                    .attr("width", width)
                    .attr("height", height)


                // x Axis
                svg.append("g")
                    .attr("transform", "translate("+50+","+500+")")
                    .call(d3.axisBottom(xScale)
                    .tickValues([0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1])
                    .tickFormat(d3.format("~%")))

                // x axis label
                svg.append("text")
                    .attr("class", "xlabel")
                    .attr("text-anchor", "middle")
                    .attr("x", width/2)
                    .attr("y", height - 15)
                    .text("Pick or Ban Rate");

                // y Axis
                svg.append("g")
                    .attr("transform", "translate("+50+","+50+")")
                    .call(d3.axisLeft(yScale)
                    .tickValues([0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1])
                    .tickFormat(d3.format("~%")));

                // y axis label
                svg.append("text")
                    .attr("class", "ylabel")
                    .attr("text-anchor", "middle")
                    .attr("y", 0)
                    .attr("x", -height/2)
                    .attr("dy", ".75em")
                    .attr("transform", "rotate(-90)")
                    .text("Winrate");


                // add the X gridlines
                svg.append("g")			
                    // .attr("transform", "translate(" + margin.x + "," + margin.y + ")")
                    .attr("class", "gridline")
                    .attr("transform", "translate(50," + (height - 50) + ")")
                    .call(make_x_gridlines()
                        .tickSize(-height + 100)
                        .tickFormat("")
                    )

                // add the Y gridlines
                svg.append("g")			
                    // .attr("transform", "translate(" + margin.x + "," + margin.y + ")")
                    .attr("class", "gridline")
                    .attr("transform", "translate(50, 50 )")
                    .call(make_y_gridlines()
                        .tickSize(-width + 100)
                        .tickFormat("")
                    )

                const scene1Anno = [{
                    note: {
                        label: "Added connector end 'arrow', note wrap '180', and note align 'left'",
                        title: "d3.annotationLabel",
                        wrap: 150,
                        align: "left"
                    },
                    subject: {
                        radius: 50
                    },
                    connector: {
                        end: "arrow" // 'dot' also available
                    },
                    x: 170,
                    y: 150,
                    dy: 137,
                    dx: 162
                    },].map(function(d){ d.color = "#E8336D"; return d})


                // Define the two scatterplot groups
                var group1 = svg.append("g")
                    .attr("transform", "translate(" + margin.x + "," + margin.y + ")");
                
                var group2 = svg.append("g")
                    .attr("transform", "translate(" + margin.x + "," + margin.y + ")");
                

                
                var currentYear1 = "2011"
                // Year button 1
                d3.select("#yearButton1")
                .selectAll('myOptions')
                    .data(allYears)
                .enter()
                    .append('option')
                .text(function (d) { return d; })
                .attr("value", function (d) { return d; })

                
                var currentYear2 = "2016"
                // Year button 2
                d3.select("#yearButton2")
                .selectAll('myOptions')
                    .data(allYears)
                .enter()
                    .append('option')
                .text(function (d) { return d; })
                .attr("value", function (d) { return d; })
                .property("selected", function(d){ return d === "2016"; })


                
                var currentChamp = "Lee Sin"
                // Champ button 
                d3.select("#champButton")
                .selectAll('myOptions')
                    .data(allChamps)
                .enter()
                    .append('option')
                .text(function (d) { return d; })
                .attr("value", function (d) { return d; })
                .property("selected", function(d){ return d === currentChamp; })



                var yearColor = d3.scaleOrdinal()
                    .domain(allYears)
                    .range(d3.schemeSet2);

                
                var colors = d3.scaleOrdinal()
                .domain(allYears)
                .range(["#bd1a1a", "#e86500", "#fcf403", "#71f505", "#048014", 
                        "#0ccf9b", "#42c4eb", "#362deb", "#8c12c4", "#e60e96", "#365675"]);
                
                var symbol = d3.symbol();

                // color = d3.scaleOrdinal(d3.schemeCategory10)
                shape = d3.scaleOrdinal(
                    data.map(d => d.year),
                    d3.symbols.map(s => d3.symbol().type(s)()))

                var tooltipDiv = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);


                
                var scatterplot1 = group1.selectAll('path').data(data.filter(function(d){return d.Year==allYears[0]}))
                    .join("path")
                    .attr("transform",
                    d => "translate(" + xScale(d.PB/100) + "," + yScale(d.W/100) + ")")
                    .attr("d", d3.symbol().type(d3.symbolCircle).size(function(d){return d.GP * 50}))
                    .attr("fill", function(d){return colors(allYears[0])})
                    .attr("opacity","0.8")
                    .style("z-index", "-1")
                        .on("mouseover", function(d){
                            tooltipDiv.transition()		
                            .duration(100)		
                            .style("opacity", .9);
                            tooltipDiv	.html("Champion: " + d.Champion + "<br/>" + 
                            "Position: " + d.Pos + "<br/>" + 
                            "Year: " + d.Year + "<br/>" + 
                            "Games Played: " + d.GP + "<br/>" + 
                            "Winrate: " + d.W + "%" + "<br/>" + 
                            "Pick Rate: " + d.P + "%" + "<br/>" + 
                            "Ban Rate: " + d.B + "%" +  "<br/>" + 
                            "Pick or Ban Rate: " + d.PB + "%")	
                                .style("left", (d3.event.pageX) + "px")		
                                .style("top", (d3.event.pageY) + 10 + "px")
                                .style("width", function() {
                                if (d.Champion == "Nunu & Willump"){
                                    return "150px";
                                }
                                return "140px"});
                            d3.select(this).style('stroke', 'black');
                            })
                            .on("mouseout", function(d) {		
                                tooltipDiv.transition()		
                                    .duration(200)		
                                    .style("opacity", 0);	
                                d3.select(this).style('stroke', 'transparent');
                            });

                var scatterplot2 = group2.selectAll('path').data(data.filter(function(d){return d.Year==allYears[5]}))
                    .join("path")
                    .attr("transform",
                    d => "translate(" + xScale(d.PB/100) + "," + yScale(d.W/100) + ")")
                    .attr("d", d3.symbol().type(d3.symbolCross).size(function(d){return d.GP * 25}))
                    .attr("fill", function(d){return colors(allYears[5])})
                    .attr("opacity","0.8")
                        .on("mouseover", function(d){
                            tooltipDiv.transition()		
                            .duration(200)		
                            .style("opacity", .9);
                            tooltipDiv.html("Champion: " + d.Champion + "<br/>" + 
                            "Position: " + d.Pos + "<br/>" + 
                            "Year: " + d.Year + "<br/>" + 
                            "Games Played: " + d.GP + "<br/>" + 
                            "Winrate: " + d.W + "%" + "<br/>" + 
                            "Pick Rate: " + d.P + "%" + "<br/>" + 
                            "Ban Rate: " + d.B + "%" +  "<br/>" + 
                            "Pick or Ban Rate: " + d.PB + "%")	
                                .style("left", (d3.event.pageX) + "px")		
                                .style("top", (d3.event.pageY) + 10 + "px")
                                .style("width", function() {
                                if (d.Champion == "Nunu & Willump"){
                                    return "150px";
                                }
                                return "140px"});
                            d3.select(this).style('stroke', 'black');
                            })
                            .on("mouseout", function(d) {		
                                tooltipDiv.transition()		
                                    .duration(500)		
                                    .style("opacity", 0);	
                                d3.select(this).style('stroke', 'transparent');
                            });
                
                var labels1 = svg.append("g")
                    .attr("transform", "translate(" + margin.x + "," + margin.y + ")")
                    .selectAll("text").data(data.filter(function(d){return d.Year==allYears[0]}))
                    .enter().append("text")
                    .attr("class", "labels1")
                    .text(function(d) {if (d.Champion == "Lee Sin") {
                        return d.Champion
                    }
                        return ""})
                    .attr("x", function(d) {return xScale(d.PB/100)})
                    .attr("y", function(d) {return yScale(d.W/100)});


                var labels2 = svg.append("g")
                    .attr("transform", "translate(" + margin.x + "," + margin.y + ")")
                    .selectAll("text").data(data.filter(function(d){return d.Year==allYears[5]}))
                    .enter().append("text")
                    .attr("class", "labels2")
                    .text(function(d) {if (d.Champion == "Lee Sin") {
                        return d.Champion
                    }
                        return ""})
                    .attr("x", function(d) {return xScale(d.PB/100)})
                    .attr("y", function(d) {return yScale(d.W/100)});
        
                
                // Add annotations 
                const makeScene1Anno = d3.annotation()
                    .type(d3.annotationCalloutCircle)
                    .annotations(scene1Anno)

                    svg.append("g")
                    .attr("class", "annotation-group-scene-1")
                    .call(makeScene1Anno)

                const makeScene2anno = d3.annotation()
                    .type(d3.annotationLabel)
                    .annotations(scene1Anno)

                    svg.append("g")
                    .attr("class", "annotation-group-scene-1")
                    .call(makeScene1Anno)
                
                const makeScene3Anno = d3.annotation()
                    .type(d3.annotationLabel)
                    .annotations(scene1Anno)

                    svg.append("g")
                    .attr("class", "annotation-group-scene-1")
                    .call(makeScene1Anno)



                // Update scatterplot
                function updateYear(newYear, scatterplot, group, symbol, labels) {

                    var dataFilter = data.filter(function(d){return d.Year==newYear})
                    scatterplot
                        .data(dataFilter)
                        .transition()
                        .duration(1000)
                        .attr("transform",
                            d => "translate(" + xScale(d.PB/100) + "," + yScale(d.W/100) + ")")
                        .attr("fill", function(d){return colors(newYear)})
                        .attr("d", d3.symbol().type(symbol).size(function(d){return d.GP * 25}))
                    
                    labels
                        .data(dataFilter)
                        .transition()
                        .duration(1000)
                        .text(function(d) {
                            if (d.Champion == currentChamp) {
                                return d.Champion
                            }
                            return ""}
                            )
                        .attr("x", function(d) {return xScale(d.PB/100)})
                        .attr("y", function(d) {return yScale(d.W/100)});



                        group.selectAll('path').each(function(d) {

                        if (d.Year != newYear) {
                            d3.select(this).remove()
                        }
                        })


                    }

                    function updateChamp(newChamp) {

                        currentChamp = newChamp

                        var dataFilter1 = data.filter(function(d){return d.Year==currentYear1})
                        var dataFilter2 = data.filter(function(d){return d.Year==currentYear2})
                        console.log("here")

                        labels1
                        .data(dataFilter1)
                        .transition()
                        .duration(1000)
                        .text(function(d) {
                            if (d.Champion == currentChamp) {
                                return d.Champion
                            }
                            return ""}
                            )
                        .attr("x", function(d) {return xScale(d.PB/100)})
                        .attr("y", function(d) {return yScale(d.W/100)});


                        labels2
                        .data(dataFilter2)
                        .transition()
                        .duration(1000)
                        .text(function(d) {
                            if (d.Champion == currentChamp) {
                                return d.Champion
                            }
                            return ""}
                            )
                        .attr("x", function(d) {return xScale(d.PB/100)})
                        .attr("y", function(d) {return yScale(d.W/100)});

                    }


                    d3.select("#yearButton1").on("change", function(d) {
                        var newYear = d3.select(this).property("value")
                        currentYear1 = newYear
                        updateYear(newYear, scatterplot1, group1, d3.symbolCircle, labels1)
                    })

                    d3.select("#yearButton2").on("change", function(d) {
                        var newYear = d3.select(this).property("value")
                        currentYear2 = newYear
                        updateYear(newYear, scatterplot2, group2, d3.symbolCross, labels2)
                    })

                    d3.select("#champButton").on("change", function(d) {
                        var newChamp = d3.select(this).property("value")
                        updateChamp(newChamp)
                    })


                function make_x_gridlines() {		
                    return d3.axisBottom(xScale)
                        .ticks(9)
                }

                function make_y_gridlines() {		
                    return d3.axisLeft(yScale)
                        .ticks(9)
                }




                function scene2Transition() {

                }

                function scene3Transition() {

                }

            }

        </script>
    </body>
</html>